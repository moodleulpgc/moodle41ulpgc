YUI.add("moodle-quizaccess_wifiresilience-localforage",(function(Y,NAME){M.quizaccess_wifiresilience=M.quizaccess_wifiresilience||{},M.quizaccess_wifiresilience.localforage={SELECTORS:{QUIZ_FORM:"#responseform",PER_QUESTION_BLOCK:".quiz-loading-hide"},LOCAL_STORAGE_KEY_PREFIX:"Wifiresilience-exams-",keyname:null,responses_store:null,status_store:null,responses_details_store:null,questions_store:null,init:function(keyname){if(quizaccess_wifiresilience_progress_step=4,$("#quizaccess_wifiresilience_result").html(M.util.get_string("loadingstep4","quizaccess_wifiresilience")),this.form=Y.one(this.SELECTORS.QUIZ_FORM),this.form){this.keyname=keyname,this.status_store=localforage.createInstance({name:"Wifiresilience-exams-question-status"}),this.responses_store=localforage.createInstance({name:"Wifiresilience-exams-responses"}),this.question_state_classes=localforage.createInstance({name:"Wifiresilience-exams-question_state_classes"}),this.question_state_strings=localforage.createInstance({name:"Wifiresilience-exams-question_state_strings"});var examviewportmaxwidth=$(window).width(),quizaccess_wifiresilience_progress;$(".quizaccess_wifiresilience_progress .quizaccess_wifiresilience_bar").animate({width:4*examviewportmaxwidth/10+"px"})}else Y.log("No response form found. Why did you try to set up download?","debug","[Wifiresilience-SW] LocalStorage")},save_question_state_classes:function(classesdata){classesdata&&this.question_state_classes.setItem(this.keyname,classesdata).then((function(){return!0})).then((function(value){return!0})).catch((function(err){return!0}))},save_question_state_strings:function(classesstrings){classesstrings&&this.question_state_strings.setItem(this.keyname,classesstrings).then((function(){return!0})).then((function(value){return!0})).catch((function(err){return!0}))},update_question_state_class:function(slot,value){slot&&value&&this.question_state_classes.getItem(this.keyname).then((function(item){var item;item&&"undefined"!=item?item[slot]=value:(item=new Object)[slot]=value;M.quizaccess_wifiresilience.localforage.save_question_state_classes(item)}))},update_question_state_string:function(slot,value){slot&&value&&this.question_state_strings.getItem(this.keyname).then((function(item){var item;item&&"undefined"!=item?item[slot]=value:(item=new Object)[slot]=value;M.quizaccess_wifiresilience.localforage.save_question_state_strings(item)}))},save_status_records:function(nonencrypteddata){nonencrypteddata&&this.status_store.setItem(this.keyname,nonencrypteddata).then((function(){return!0})).then((function(value){return!0})).catch((function(err){return!0}))},try_to_get_question_states:function(){this.keyname&&(this.question_state_classes.getItem(this.keyname,(function(err,value){value&&"undefined"!=value&&(M.quizaccess_wifiresilience.autosave.update_question_state_classes(value),Y.log("Done Getting Questions State Status/Classes","debug","[Wifiresilience-SW] LocalStorage"))})),this.question_state_strings.getItem(this.keyname,(function(err,value){value&&"undefined"!=value&&(M.quizaccess_wifiresilience.autosave.update_question_state_strings(value),Y.log("Done Getting Questions State Strings","debug","[Wifiresilience-SW] LocalStorage"))})))},get_status_records:function(){this.keyname&&this.status_store.getItem(this.keyname,(function(err,value){var storeddata=value;Y.log("[FORM-REFILL]: We have got store data now :-)","debug","[Wifiresilience-SW] LocalStorage"),storeddata&&"undefined"!=storeddata?Y.log("[IndexedDB]: Exam Data Found in IndexedDB","debug","[Wifiresilience-SW] LocalStorage"):Y.log("[FORM-REFILL]: There is no local status_store data","debug","[Wifiresilience-SW] LocalStorage"),M.quizaccess_wifiresilience.autosave.locally_stored_data=storeddata&&"undefined"!=storeddata?Y.JSON.parse(storeddata):{last_change:0,last_save:M.quizaccess_wifiresilience.autosave.last_successful_server_save_timestamp,final_submission_time:0,userid:M.quizaccess_wifiresilience.autosave.userid,real_offline_time:M.quizaccess_wifiresilience.autosave.real_offline_time,total_offline_time:M.quizaccess_wifiresilience.autosave.total_offline_time,cid:M.quizaccess_wifiresilience.autosave.courseid,cmid:M.quizaccess_wifiresilience.autosave.cmid,attemptid:M.quizaccess_wifiresilience.autosave.attemptid,responses:""};var last_change_compare=new Date(M.quizaccess_wifiresilience.autosave.locally_stored_data.last_change).getTime(),last_save_compare=new Date(M.quizaccess_wifiresilience.autosave.locally_stored_data.last_save).getTime();Y.log("[FORM-REFILL]: Checking if Local Data is newer than Server Data..","debug","[Wifiresilience-SW] LocalStorage"),last_change_compare>last_save_compare?(Y.log("[FORM-REFILL]: Local Data is indeed newer than Server Data. Repopulate the Exam with Latest Student Data","debug","[Wifiresilience-SW] LocalStorage"),M.quizaccess_wifiresilience.autosave.try_to_use_locally_saved_responses()):Y.log("[FORM-REFILL]: Local Data is NOT newer (surprisingly!) than Server Data. Use Server Data.","debug","[Wifiresilience-SW] LocalStorage")}))},save_attempt_records:function(localdata){localdata&&this.responses_store.setItem(this.keyname,localdata).then((function(){return!0})).then((function(value){return!0})).catch((function(err){return!0}))},save_attempt_records_encrypted:function(){attempt_encrypted=M.quizaccess_wifiresilience.download.downloadNeeded(),this.responses_store.setItem(this.keyname,attempt_encrypted).then((function(){return!0})).then((function(value){return!0})).catch((function(err){return!0}))},save_html_per_question:function(){if(Y.all(this.SELECTORS.PER_QUESTION_BLOCK)){var all_exam_html=document.documentElement.outerHTML;this.questions_store.getItem("Wifiresilience-crs",(function(err,value){this.questions_store=localforage.createInstance({name:"Wifiresilience-exams-all-questions"}),null===value?(this.questions_store.setItem("Wifiresilience-crs",all_exam_html),Y.log("Questions have been saved in Database","debug","[Wifiresilience-SW] LocalStorage")):Y.log("Questions are already in Database, not saved again.","debug","[Wifiresilience-SW] LocalStorage")}))}else Y.log('No Questions found with class "quiz-loading-hide" attribute',"debug","[Wifiresilience-SW] LocalStorage")},delete_records_after_successful_submission:function(){this.responses_store.removeItem(this.keyname),this.status_store.removeItem(this.keyname),this.question_state_classes.removeItem(this.keyname),this.question_state_strings.removeItem(this.keyname),localStorage.removeItem(this.keyname),Y.log("OK.. Cleared out all local data..","debug","[Wifiresilience-SW] LocalStorage")}}}),"@VERSION@",{requires:["base","node","event","event-valuechange","node-event-delegate","io-form","json","core_question_engine","mod_quiz"]});