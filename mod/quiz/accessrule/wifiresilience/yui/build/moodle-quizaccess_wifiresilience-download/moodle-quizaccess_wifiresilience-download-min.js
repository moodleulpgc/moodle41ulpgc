YUI.add("moodle-quizaccess_wifiresilience-download",(function(Y,NAME){M.quizaccess_wifiresilience=M.quizaccess_wifiresilience||{},M.quizaccess_wifiresilience.download={SELECTORS:{DOWNLOAD_CONFIRM_MESSAGE:"#quiz-download-confirm-message",QUIZ_FORM:"#responseform"},filename:null,publicKey:null,form:null,init:function(filename,publicKey){if(quizaccess_wifiresilience_progress_step=7,$("#quizaccess_wifiresilience_result").html(M.util.get_string("loadingstep7","quizaccess_wifiresilience")),this.filename=filename,this.publicKey=publicKey,Y.Crypto.sjcl.random.startCollectors(),Y.Crypto.sjcl.beware["CBC mode is dangerous because it doesn't protect message integrity."](),this.form=Y.one(this.SELECTORS.QUIZ_FORM),this.form){Y.delegate("click",this.downloadClicked,"body",".response-download-link",this);var examviewportmaxwidth=$(window).width(),quizaccess_wifiresilience_progress;$(".quizaccess_wifiresilience_progress .quizaccess_wifiresilience_bar").animate({width:7*examviewportmaxwidth/10+"px"})}else Y.log("No response form found. Why did you try to set up download?","debug","[Wifiresilience-SW] Download Emergency File")},downloadClicked:function(e){var link=e.currentTarget;"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave(),link.set("download",this.filename.replace(/-d\d+\.eth/,"-d"+this.getCurrentDatestamp()+".eth"));var data={responses:Y.IO.stringify(this.form)};this.publicKey&&(data=this.encryptResponses(data));var blob=new Blob([Y.JSON.stringify(data)],{type:"octet/stream"}),url=window.URL.createObjectURL(blob);link.set("href",url),Y.later(500,this,this.showDownloadMessage,Y.one(this.SELECTORS.DOWNLOAD_CONFIRM_MESSAGE))},downloadNeeded:function(){"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave();var data={responses:Y.IO.stringify(this.form)};return this.publicKey&&(data=this.encryptResponses(data)),Y.JSON.stringify(data)},getCurrentDatestamp:function(){var now=new Date;function pad(number){return number<10?"0"+number:number}return""+now.getUTCFullYear()+pad(now.getUTCMonth()+1)+pad(now.getUTCDate())+pad(now.getUTCHours())+pad(now.getUTCMinutes())},showDownloadMessage:function(){function pad(number){return number<10?"0"+number:number}Y.one(this.SELECTORS.DOWNLOAD_CONFIRM_MESSAGE)&&Y.one(this.SELECTORS.DOWNLOAD_CONFIRM_MESSAGE).remove(!0),now=new Date,Y.one("#mod_quiz_navblock .content").append('<p id="quiz-download-confirm-message">'+M.util.get_string("lastsavedtothiscomputer","quizaccess_wifiresilience",pad(now.getHours())+":"+pad(now.getMinutes())+":"+pad(now.getSeconds()))+"</p>")},encryptResponses:function(data){var aeskey=Y.Crypto.sjcl.random.randomWords(8),rp={},encrypted=Y.Crypto.sjcl.encrypt(aeskey,data.responses,{ks:256,mode:"cbc"},rp),jsEncrypt=new Y.Crypto.JSEncrypt;if(jsEncrypt.setPublicKey(this.publicKey),M.quizaccess_wifiresilience.autosave.connection_changed(),M.quizaccess_wifiresilience.autosave.disconnection_events&&M.quizaccess_wifiresilience.autosave.disconnection_events.length>0)var total_disconnection_times=M.quizaccess_wifiresilience.autosave.disconnection_events.reduce((function(a,b){return a+b}),0);else total_disconnection_times=0;return{last_change:M.quizaccess_wifiresilience.autosave.last_change,last_save:M.quizaccess_wifiresilience.autosave.last_successful_server_save_timestamp,final_submission_time:M.quizaccess_wifiresilience.autosave.final_submission_time,userid:M.quizaccess_wifiresilience.autosave.userid,real_offline_time:M.quizaccess_wifiresilience.autosave.real_offline_time,total_offline_time:total_disconnection_times,cid:M.quizaccess_wifiresilience.autosave.courseid,cmid:M.quizaccess_wifiresilience.autosave.cmid,attemptid:M.quizaccess_wifiresilience.autosave.attemptid,responses:Y.JSON.parse(encrypted).ct,key:jsEncrypt.encrypt(Y.Crypto.sjcl.codec.base64.fromBits(aeskey)),iv:jsEncrypt.encrypt(Y.Crypto.sjcl.codec.base64.fromBits(rp.iv))}}}}),"@VERSION@",{requires:["base","node","event","node-event-delegate","json","io-form","moodle-quizaccess_wifiresilience-jsencrypt","moodle-quizaccess_wifiresilience-sjcl"]});