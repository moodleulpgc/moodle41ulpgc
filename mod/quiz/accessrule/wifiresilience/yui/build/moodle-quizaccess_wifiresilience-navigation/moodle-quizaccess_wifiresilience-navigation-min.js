YUI.add("moodle-quizaccess_wifiresilience-navigation",(function(Y,NAME){M.quizaccess_wifiresilience=M.quizaccess_wifiresilience||{},M.quizaccess_wifiresilience.navigation={SELECTORS:{QUIZ_FORM:"#responseform",NAV_BLOCK:"#mod_quiz_navblock",NAV_BUTTON:".qnbutton",FINISH_LINK:".endtestlink",QUIZ_AUTOSBUMIT_FORM:"#quizaccess_wifiresilience_timer_autosubmit_form",NEXT_BUTTON:"input[name=next]",PREVIOUS_BUTTON:"input[name=previous]",SUMMARY_TABLE:".quizsummaryofattempt",SUMMARY_TABLE_LINK:"tr > td.c0 > a",SUMMARY_ROW:".quizsummaryofattempt tr.quizsummary",SUMMARY_LINK_IN_ROW:" > td.c0 > a",FLAG_ICON_IN_ROW:" .questionflag",SUMMARY_PAGE_BUTTON:"#quizaccess_wifiresilience-attempt_page--1 .submitbtns input[type=submit]",PAGE_DIV_ROOT:"#quizaccess_wifiresilience-attempt_page-",ALL_PAGE_DIVS:"div[id|=quizaccess_wifiresilience-attempt_page]",THIS_PAGE_INPUT:"input#followingpage",NEXT_PAGE_INPUT:"input[name=nextpage]",PREVIOUS_PAGE_INPUT:"input[name=previouspage]",FINISH_ATTEMPT_INPUT:"input[name=finishattempt]",ATTEMPT_ID_INPUT:"input[name=attempt]"},form:null,currentpage:null,intialpage:null,lastpage:null,attemptid:null,extraspaceattop:0,init:function(currentpage){if(this.form=Y.one(this.SELECTORS.QUIZ_FORM),this.form){this.attemptid=Y.one(this.SELECTORS.ATTEMPT_ID_INPUT).get("value"),quizaccess_wifiresilience_progress_step=6,$("#quizaccess_wifiresilience_result").html(M.util.get_string("loadingstep6","quizaccess_wifiresilience")),Y.all("textarea").each((function(textarea){textarea.setStyle("height",textarea.getStyle("height"))})),Y.all(this.SELECTORS.ALL_PAGE_DIVS).each((function(element){var pageno,matches=element.get("id").match(/quizaccess_wifiresilience-attempt_page-(\d+)/);matches&&(pageno=+matches[1])>this.lastpage&&(this.lastpage=pageno)}),this),this.navigate_to_page(+currentpage),Y.all(this.SELECTORS.ALL_PAGE_DIVS).removeClass("xquiz-loading-hide"),Y.delegate("click",this.nav_button_click,this.SELECTORS.NAV_BLOCK,this.SELECTORS.NAV_BUTTON,this),Y.delegate("click",this.nav_button_click,this.SELECTORS.SUMMARY_TABLE,this.SELECTORS.SUMMARY_TABLE_LINK,this),Y.one(this.SELECTORS.FINISH_LINK)&&(Y.one(this.SELECTORS.FINISH_LINK).detach("click"),Y.one(this.SELECTORS.FINISH_LINK).on("click",this.finish_attempt_click,this)),Y.one(this.SELECTORS.NEXT_BUTTON).on("click",this.next_button_click,this),Y.one(this.SELECTORS.PREVIOUS_BUTTON).on("click",this.previous_button_click,this),Y.one(this.SELECTORS.SUMMARY_PAGE_BUTTON).on("click",this.summary_button_click,this);var topbar=Y.one(".navbar-fixed-top");topbar?this.extraspaceattop=topbar.get("offsetHeight"):Y.one("#page-header-color")&&(this.extraspaceattop=Y.one("#page-header-color").get("offsetHeight")),M.core_question_flags&&M.core_question_flags.add_listener(Y.bind(this.update_flag_on_summary_page,this)),Y.log("Initialised Wifi-Resilient Exam mode.","debug","[Wifiresilience-SW] Navigation");var examviewportmaxwidth=$(window).width(),quizaccess_wifiresilience_progress;$(".quizaccess_wifiresilience_progress .quizaccess_wifiresilience_bar").animate({width:6*examviewportmaxwidth/10+"px"})}else Y.log("Response form not found.","debug","[Wifiresilience-SW] Navigation")},preload_images:function(){var alreadyLoaded={};function preload_image(url){alreadyLoaded[url]=!0,document.createElement("img").src=url}preload_image(M.util.image_url("i/flagged")),preload_image(M.util.image_url("i/unflagged")),preload_image(M.util.image_url("i/loading_small")),preload_image(M.util.image_url("navflagged","quiz")),Y.all("img").each((function(image){var url=image.get("src");alreadyLoaded[url]||preload_image(url)}))},preload_images_base64:function(img){var preload_wifi_canvas=document.createElement("canvas"),ctx,dataURL;return preload_wifi_canvas.width=img.width,preload_wifi_canvas.height=img.height,preload_wifi_canvas.getContext("2d").drawImage(img,0,0),preload_wifi_canvas.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},nav_button_click:function(e){e.halt(),e.currentTarget.hasAttribute("href")&&(this.navigate_to_page(this.page_number_from_link(e.currentTarget)),this.scroll_to_fragment_from_link(e.currentTarget))},finish_attempt_click:function(e){return e.halt(!0),this.navigate_to_page(-1),!1},next_button_click:function(e){e.halt(),this.navigate_to_page(+Y.one(this.SELECTORS.NEXT_PAGE_INPUT).get("value"))},previous_button_click:function(e){e.halt(),this.navigate_to_page(+Y.one(this.SELECTORS.PREVIOUS_PAGE_INPUT).get("value"))},summary_button_click:function(e){e.currentTarget.siblings(this.SELECTORS.FINISH_ATTEMPT_INPUT).empty()&&(e.halt(),this.navigate_to_page(+Y.one(this.SELECTORS.THIS_PAGE_INPUT).get("value")))},page_number_from_link:function(anchor){var dataValue=anchor.getData("quiz-page");if(void 0!==dataValue)return+dataValue;if(anchor.hasAttribute("href")){var pageidmatch=anchor.get("href").match(/page=(\d+)/);if(pageidmatch)return+pageidmatch[1]}return 0},scroll_to_fragment_from_link:function(anchor){var fragmentidmatch=anchor.get("href").match(/#(?:q\d+)?$/);if(fragmentidmatch){if(window.history.replaceState){var url=window.location.href;url.match(/#[^#]*$/)?url=url.replace(/#[^#]*$/,fragmentidmatch[0]):url+=fragmentidmatch[0],window.history.replaceState(null,"",url)}var target;if("#"===fragmentidmatch[0]&&window.scrollTo(0,0),target=Y.one(fragmentidmatch[0]))window.scrollTo(0,target.getY()-this.extraspaceattop);else if(Y.one(fragmentidmatch[0].replace("q","question-"+M.quizaccess_wifiresilience.autosave.usageid+"-"))){var target=Y.one(fragmentidmatch[0].replace("q","question-"+M.quizaccess_wifiresilience.autosave.usageid+"-"));window.scrollTo(0,target.getY()-this.extraspaceattop)}}},navigate_to_page:function(pageno){if(pageno!==this.currentpage){var livewatchel;if(M.quizaccess_wifiresilience.autosave.livewatch=!0,(document.querySelector("#quizaccess_wifiresilience_hidden_livewatch_status").value=1).value=1,null!==this.currentpage&&Y.one(this.SELECTORS.PAGE_DIV_ROOT+this.currentpage).addClass("quizaccess_wifiresilience_hidden"),-1===pageno?Y.one(this.SELECTORS.QUIZ_FORM).addClass("quizaccess_wifiresilience_hidden"):Y.one(this.SELECTORS.QUIZ_FORM).removeClass("quizaccess_wifiresilience_hidden"),0==pageno||-1==pageno?Y.one(this.SELECTORS.PREVIOUS_BUTTON).hide():Y.one(this.SELECTORS.PREVIOUS_BUTTON).show(),-1==pageno?Y.one(this.SELECTORS.NEXT_BUTTON).hide():Y.one(this.SELECTORS.NEXT_BUTTON).show(),Y.one(this.SELECTORS.PAGE_DIV_ROOT+pageno).removeClass("quizaccess_wifiresilience_hidden"),Y.one(this.SELECTORS.NAV_BLOCK).all(this.SELECTORS.NAV_BUTTON).each((function(node){this.page_number_from_link(node)===pageno?node.addClass("thispage"):node.removeClass("thispage")}),this),pageno>=0&&(Y.one(this.SELECTORS.THIS_PAGE_INPUT).set("value",pageno),pageno<this.lastpage?Y.one(this.SELECTORS.NEXT_PAGE_INPUT).set("value",pageno+1):Y.one(this.SELECTORS.NEXT_PAGE_INPUT).set("value",-1),0==pageno?Y.one(this.SELECTORS.PREVIOUS_PAGE_INPUT).set("value",-1):Y.one(this.SELECTORS.PREVIOUS_PAGE_INPUT).set("value",pageno-1)),window.history.replaceState){var queryString=window.location.search;queryString.match(/\bpage=-?\d+/)?queryString=queryString.replace(/\bpage=-?\d+/,"page="+pageno):queryString+="&page="+pageno,window.history.replaceState(null,"",M.cfg.wwwroot+"/mod/quiz/accessrule/wifiresilience/attempt.php"+queryString)}this.currentpage=pageno,window.scrollTo(0,0)}},update_flag_on_summary_page:function(notused,slot,newstate){if("1"===newstate){var icon=Y.Node.create('<img class="questionflag icon-post" />').setAttrs({src:M.util.image_url("i/flagged","core"),title:M.util.get_string("flagged","question")});Y.one(this.SELECTORS.SUMMARY_ROW+slot+this.SELECTORS.SUMMARY_LINK_IN_ROW).append(icon)}else Y.all(this.SELECTORS.SUMMARY_ROW+slot+this.SELECTORS.FLAG_ICON_IN_ROW).remove()}}}),"@VERSION@",{requires:["base","node","event","event-valuechange","node-event-delegate","io-form","moodle-core-notification-confirm"]});