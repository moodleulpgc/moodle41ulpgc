YUI.add("moodle-atto_chemistry-button",function(t){var e="atto_chemistry",i={CHEMISTRY_TEXT:"atto_chemistry_chemistry",CHEMISTRY_PREVIEW:"atto_chemistry_preview",SUBMIT:"atto_chemistry_submit",LIBRARY:"atto_chemistry_library",LIBRARY_GROUPS:"atto_chemistry_groups",LIBRARY_GROUP_PREFIX:"atto_chemistry_group"},n={LIBRARY:"."+i.LIBRARY,LIBRARY_GROUP:"."+i.LIBRARY_GROUPS+" > div > div",CHEMISTRY_TEXT:"."+i.CHEMISTRY_TEXT,CHEMISTRY_PREVIEW:"."+i.CHEMISTRY_PREVIEW,SUBMIT:"."+i.SUBMIT,LIBRARY_BUTTON:"."+i.LIBRARY+" button"},s={START:"\\(\\ce{ ",END:" }\\)"},o={FORM:'<form class="atto_form">{{{library}}}<label for="{{elementid}}_{{CSS.CHEMISTRY_TEXT}}">{{{get_string "editchemistry" component texdocsurl}}}</label><textarea class="fullwidth {{CSS.CHEMISTRY_TEXT}}" id="{{elementid}}_{{CSS.CHEMISTRY_TEXT}}" rows="8"></textarea><br/><label for="{{elementid}}_{{CSS.CHEMISTRY_PREVIEW}}">{{get_string "preview" component}}</label><div describedby="{{elementid}}_cursorinfo" class="well well-small fullwidth {{CSS.CHEMISTRY_PREVIEW}}" id="{{elementid}}_{{CSS.CHEMISTRY_PREVIEW}}"></div><div id="{{elementid}}_cursorinfo">{{get_string "cursorinfo" component}}</div><div class="mdl-align"><br/><button class="{{CSS.SUBMIT}}">{{get_string "savechemistry" component}}</button></div></form>',LIBRARY:'<div class="{{CSS.LIBRARY}}"><ul>{{#each library}}<li><a aria-label="{{get_string grouptitle ../component}}" title="{{get_string grouptitle ../component}}" href="#{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}">{{get_string groupname ../component}}</a></li>{{/each}}</ul><div class="{{CSS.LIBRARY_GROUPS}}">{{#each library}}<div id="{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}"><div role="toolbar">{{#split "\n" elements}}<button tabindex="-1" data-tex="{{this}}" aria-label="{{this}}" title="{{this}}">{{../../DELIMITERS.START}}{{this}}{{../../DELIMITERS.END}}</button>{{/split}}</div></div>{{/each}}</div></div>'};t.namespace("M.atto_chemistry").Button=t.Base.create("button",t.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_lastCursorPos:0,_content:null,_sourceChemistry:null,_groupFocus:null,_chemistryPatterns:[/\$\$(\\ce\{[\S\s]+?)\}\$\$/,/\\\(\\ce\{([\S\s]+?)\}\\\)/,/\\\[\\ce\{([\S\s]+?)\}\\\]/,/\[tex\]\\ce\{([\S\s]+?)\}\[\/tex\]/],initializer:function(){this._groupFocus={},this.get("texfilteractive")&&(this.addButton({icon:"icon",iconComponent:e,callback:this._displayDialogue}),this.get("host").on("atto:selectionchanged",function(){this._resolveChemistry()?this.highlightButtons():this.unHighlightButtons()},this),this.editor.all("tex").each(function(e){var i=t.Node.create("<span>"+s.START+" "+e.get("text")+" "+s.END+"</span>");e.replace(i)}))},_displayDialogue:function(){if(this._currentSelection=this.get("host").getSelection(),this._currentSelection!==!1){var i=this._resolveChemistry(),s=this.getDialogue({headerContent:M.util.get_string("pluginname",e),focusAfterHide:!0,width:600,focusOnShowSelector:n.CHEMISTRY_TEXT}),o=this._getDialogueContent();s.set("bodyContent",o);var r=o.one(n.LIBRARY),a=new t.TabView({srcNode:r});a.render(),s.show(),t.fire(M.core.event.FILTER_CONTENT_UPDATED,{nodes:new t.NodeList(s.get("boundingBox"))}),i&&o.one(n.CHEMISTRY_TEXT).set("text",i),this._updatePreview(!1)}},_resolveChemistry:function(){var e,i=this.get("host").getSelectionParentNode(),n=this.get("host").getSelection(),s=!1;return this.get("host").isActive()&&i&&n&&0!==n.length?(this.sourceChemistry=null,n=n[0],e=t.one(i).get("text"),t.Array.find(this._chemistryPatterns,function(i){var o=e.match(new RegExp(i.source,"g"));return o&&o.length?t.Array.find(o,function(t){for(var o=0;-1!==e.indexOf(t,o);){var r=e.indexOf(t,o),a=r+t.length,c=n.startOffset>=r&&n.startOffset<a,l=n.endOffset<=a&&n.endOffset>r;if(c&&l){var u=t.match(i);if(u&&u.length){var h=e.indexOf(u[1],r),d=h+u[1].length;return s=u[1],this.sourceChemistry={startOuterPosition:r,endOuterPosition:a,outerMatch:t,startInnerPosition:h,endInnerPosition:d,innerMatch:u},!0}}o=a}},this):void 0},this),s!==!1&&(s=s.trim()),s):!1},_setChemistry:function(e){var i,n,o,r,a,c;a=this.get("host"),e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),i=e.currentTarget.ancestor(".atto_form").one("textarea"),r=i.get("value"),""!==r&&(a.setSelection(this._currentSelection),this.sourceChemistry?(n=t.one(a.getSelectionParentNode()),o=n.get("text"),r=" "+r+" ",c=o.slice(0,this.sourceChemistry.startInnerPosition)+r+o.slice(this.sourceChemistry.endInnerPosition),n.set("text",c)):(r=s.START+" "+r+" "+s.END,a.insertContentAtFocusPoint(r)),this.markUpdated())},_throttle:function(t,e){var i=null;return function(){var n=this,s=arguments;clearTimeout(i),i=setTimeout(function(){t.apply(n,s)},e)}},_updatePreview:function(e){var i,o,r,a=this._content.one(n.CHEMISTRY_TEXT),c=a.get("value"),l=a.get("selectionStart"),u="",h="$\\Downarrow$ ";for(e&&e.preventDefault(),l||(l=0);"\\"===c.charAt(l)&&l>=0;)l-=1;if(o=/[a-zA-Z\{\}]/,0!==l)for(;o.test(c.charAt(l))&&l<c.length&&o.test(c.charAt(l-1));)l+=1;this._lastCursorPos=l,c=u+c.substring(0,l)+h+c.substring(l),c=s.START+" "+c+" "+s.END,i=M.cfg.wwwroot+"/lib/editor/atto/plugins/chemistry/ajax.php",r={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:c},t.io(i,{context:this,data:r,timeout:500,on:{complete:this._loadPreview}})},_loadPreview:function(e,i){var s=this._content.one(n.CHEMISTRY_PREVIEW);200===i.status&&(s.setHTML(i.responseText),t.fire(M.core.event.FILTER_CONTENT_UPDATED,{nodes:new t.NodeList(s)}))},_getDialogueContent:function(){var s=this._getLibraryContent(),r=this._throttle(this._updatePreview,500),a=t.Handlebars.compile(o.FORM);return this._content=t.Node.create(a({elementid:this.get("host").get("elementid"),component:e,library:s,texdocsurl:this.get("texdocsurl"),CSS:i})),this._content.all(n.LIBRARY_GROUP).each(function(t){this._setGroupTabFocus(t,t.one("button")),t.all("button a").setAttribute("tabindex","-1")},this),this._content.delegate("key",this._groupNavigation,"down:37,39",n.LIBRARY_BUTTON,this),this._content.one(n.SUBMIT).on("click",this._setChemistry,this),this._content.one(n.CHEMISTRY_TEXT).on("valuechange",r,this),this._content.one(n.CHEMISTRY_TEXT).on("mouseup",r,this),this._content.one(n.CHEMISTRY_TEXT).on("keyup",r,this),this._content.delegate("click",this._selectLibraryItem,n.LIBRARY_BUTTON,this),this._content},_groupNavigation:function(t){t.preventDefault();var e,i=t.currentTarget,n=i.get("parentNode"),s=n.all("button"),o=37!==t.keyCode?1:-1,r=s.indexOf(i);0>r&&(r=0),r+=o,0>r?r=s.size()-1:r>=s.size()&&(r=0),e=s.item(r),this._setGroupTabFocus(n,e),e.focus()},_setGroupTabFocus:function(t,e){var i=t.generateID();"undefined"!=typeof this._groupFocus[i]&&this._groupFocus[i].setAttribute("tabindex","-1"),this._groupFocus[i]=e,e.setAttribute("tabindex",0),t.setAttribute("aria-activedescendant",e.generateID())},_selectLibraryItem:function(t){var e,i,n,s=t.currentTarget.getAttribute("data-tex"),o=0;t.preventDefault(),this._setGroupTabFocus(t.currentTarget.get("parentNode"),t.currentTarget),n=t.currentTarget.ancestor(".atto_form").one("textarea"),e=n.get("value"),i=e.substring(0,this._lastCursorPos),s=s.replace("$]","$"),s=s.replace("[$","$"),/[a-zA-Z]+[\^\d]*\-/.test(s)&&(s+=" ")," "!==i.charAt(i.length-1)&&((/v$/.test(s)||/\^$/.test(s)||/^</.test(s)||/^->/.test(s)||/^v\s/.test(s)||/^\^\s/.test(s)||/\}\]$/.test(i)||/>$/.test(i))&&(i+=" "),/^\\bond\{.{1,4}\}/.test(s)&&/\\bond\{.{1,4}\}$/.test(i)&&(i+=" ")),i+=s,o=i.length+1," "!==e.charAt(this._lastCursorPos)&&(/\sv$/.test(i)||/\s\^$/.test(i)||/\}\]$/.test(i)||/>$/.test(i))&&(i+=" "),i+=e.substring(this._lastCursorPos,e.length),n.set("value",i),n.focus();var r=n.getDOMNode();if("number"==typeof r.selectionStart)r.selectionStart=r.selectionEnd=o;else if("undefined"!=typeof r.createTextRange){var a=r.createTextRange();a.moveToPoint(o),a.select()}this._updatePreview(!1)},_getLibraryContent:function(){var n=t.Handlebars.compile(o.LIBRARY),r=this.get("library"),a="";t.Handlebars.registerHelper("split",function(t,e,i){var n,s,o;if("undefined"==typeof t||"undefined"==typeof e)return"";for(o="",n=e.trim().split(t);n.length>0;)s=n.shift().trim(),o+=i.fn(s);return o}),a=n({elementid:this.get("host").get("elementid"),component:e,library:r,CSS:i,DELIMITERS:s});var c=M.cfg.wwwroot+"/lib/editor/atto/plugins/chemistry/ajax.php",l={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:a},u=t.io(c,{sync:!0,data:l,method:"POST"});return 200===u.status&&(a=u.responseText),a}},{ATTRS:{texfilteractive:{value:!1},contextid:{value:null},library:{value:{}},texdocsurl:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","moodle-core-event","io","event-valuechange","tabview","array-extras"]});
